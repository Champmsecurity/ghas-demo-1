name: Security Checks

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  security-events: write

jobs:
  code-scanning:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
 
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python  # Change as per your project
 
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        
      - name: Fetch Code Scanning Alerts
        run: |
           curl -H "Authorization: token ${{secrets.PAT_TOKEN}}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/Champmsecurity/ghas-demo-1/code-scanning/alerts \
               -o code-scanning-alerts.json
      - name: Upload Code Scanning Alerts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: code-scanning-alerts
          path: code-scanning-alerts.json

  secret-scanning:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: secret-scanning-custom-action
        uses: advanced-security/secret-scanning-tools@v1
        
      - name: Fetch Secret Scanning Alerts
        run: |
          curl -H "Authorization: token ${{secrets.PAT_TOKEN}}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/Champmsecurity/ghas-demo-1/secret-scanning/alerts \
               -o secret-scanning-alerts.json
      - name: Upload Secret Scanning Alerts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: secret-scanning-alerts
          path: secret-scanning-alerts.json

  dependabot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Fetch Dependabot Alerts
        run: |
          curl -H "Authorization: token ${{secrets.PAT_TOKEN}}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/Champmsecurity/ghas-demo-1/dependabot/alerts?state=open&per_page=100&page=1 \
               -o dependabot-alerts.json
      - name: Upload Dependabot Alerts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: dependabot-alerts
          path: dependabot-alerts.json
 
  combine-alerts:
    runs-on: ubuntu-latest
    needs: [code-scanning, secret-scanning, dependabot]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Code Scanning Alerts
        uses: actions/download-artifact@v4
        with:
          name: code-scanning-alerts

      - name: Download Secret Scanning Alerts
        uses: actions/download-artifact@v4
        with:
          name: secret-scanning-alerts

      - name: Download Dependabot Alerts
        uses: actions/download-artifact@v4
        with:
          name: dependabot-alerts

      - name: Combine All Alerts into One JSON
        run: |
          jq -n \
            --slurpfile code code-scanning-alerts.json \
            --slurpfile secret secret-scanning-alerts.json \
            --slurpfile dependabot dependabot-alerts.json \
            '{code_scanning: $code[0], secret_scanning: $secret[0], dependabot: $dependabot[0]}' \
            > all-alerts.json

      - name: Upload Combined Alerts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: all-alerts
          path: all-alerts.json
      
      - name: Commit and push all-alerts.json
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add all-alerts.json
          git commit -m "Update all-alerts.json [skip ci]" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
